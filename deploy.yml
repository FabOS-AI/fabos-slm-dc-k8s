---
- name: "Create inventory with target host(s)"
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Use inventory Helper to setup ansible inventory
      ansible.builtin.include_role:
        name: inventory_helper

- name: Converge - Gather facts
  hosts: all
  gather_facts: no
  become: yes
  tasks:
    - name: Gather Facts
      ansible.builtin.setup:
        gather_subset:
          - min
          - network
      register: setup_result
      until: setup_result.failed != true
      retries: 10

- name: Check required parameters from Vault
  hosts: localhost
  connection: local
  gather_facts: no
  run_once: yes
  tasks:
    - name: "Include vars file"
      include_vars:
        file: ./playbooks/vars/main.yml
    - debug:
        var: vault_lookup_base_info
    - debug:
        var: resource_id
    # - name: Get config from environment variables
    #   ansible.builtin.set_fact:
    #     vault_url: "{{ lookup('env', 'VAULT_URL') }}"
    #     vault_approle_role_id: "{{ lookup('env', 'VAULT_APPROLE_ROLE_ID') }}"
    #     vault_approle_secret_id: "{{ lookup('env', 'VAULT_APPROLE_SECRET_ID') }}"
    #   # no_log: true
    # - name: Set Vault lookup base info
    #   ansible.builtin.set_fact:
    #     vault_lookup_base_info: "url={{ vault_url }} auth_method=approle role_id={{ vault_approle_role_id }} secret_id={{ vault_approle_secret_id }}"
      # no_log: true
    - name: "Read 'kubeconfig' from Vault (old)"
      set_fact:
        kubernetes_kubeconfig: "{{ lookup('hashi_vault', '{{ vault_lookup_base_info }} secret=resources/data/{{ resource_id }}:kubeconfig') }}"
      # no_log: yes
    - name: "Read 'kubeconfig' from Vault"
      set_fact:
        kubernetes_kubeconfig: "{{ lookup('community.hashi_vault.hashi_vault', '{{ vault_lookup_base_info }} secret=resources/data/{{ resource_id }}:kubeconfig') }}"
      # no_log: yes
    - name: "Read 'namespace' from Vault"
      set_fact:
        kubernetes_namespace: "{{ lookup('community.hashi_vault.hashi_vault', '{{ vault_lookup_base_info }} secret=resources/data/{{ resource_id }}:namespace') }}"
      # no_log: yes
      ignore_errors: true
    - name: "Set namespace to service_id (since namespace seems not defined in vault, most likely due to cluster was installed by capability)"
      set_fact:
        kubernetes_namespace: "{{ service_id }}"
      when: "kubernetes_namespace is undefined"
    - name: "Set namespace to service_id (since namespace seems to be empty in vault, most likely due to cluster was installed by capability)"
      set_fact:
        kubernetes_namespace: "{{ service_id }}"
      when: "(kubernetes_namespace | length) == 0"
    - name: "Check required variables"
      assert:
        that: "{{ item.name }} is defined and {{ item.name }} | length > 0"
        fail_msg: "Missing variable '{{ item.name }}': {{ item.description }}"
      loop: "{{ deployment_parameters }}"

- name: Deploy on Kubernetes
  hosts: localhost
  connection: local
  gather_facts: no
#  become: yes
  run_once: yes
  tasks:
    - name: "Include use - deploy"
      include_role:
        name: "use"
        tasks_from: deploy_with_kubeconfig.yml